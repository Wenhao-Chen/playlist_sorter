let tt = {
  "[AUDIO] Dirty - Miryo [English Translations]": ["Dirty", "Miryo"],
  "王菀之  我真的受傷了": ["我真的受傷了", "王菀之"],
  "[大张伟]《Miss You》花儿乐队 歌词 好歌慢歌推荐 原版 [DA ZHANG WEI]《MISS YOU》THE FLOWERS LYRICS": ["Miss You", "花儿乐队"],
  "[大张伟] 《幸福的旁边》花儿乐队 歌词 好歌推荐 [DA ZHANG WEI]《XING FU DE PANG BIAN》LYRICS THE FLOWERS": ["幸福的旁边", "花儿乐队"],
  "[大张伟] 《起飞》花儿乐队 歌词 好歌推荐 幸福在旁边 [DA ZHANG WEI]《QI FEI》LYRICS THE FLOWERS": ["起飞", "花儿乐队"],
  "花儿乐队 - 歌唱": ["歌唱", "花儿乐队"],
  "花兒|靜止": ["静止", "花儿乐队"],
  "《中国好声音》第9期 梁博: 花火": ["花火", "梁博"],
  "中国好声音0803梁博 长安长安 无杂音版": ["长安长安", "梁博"],
  "【纯享版】吴青峰《蜂鸟》 《歌手2019》第10期 Singer EP10【湖南卫视官方HD】": ["蜂鸟", "吴青峰"],
  "单依纯 Shan Yi Chun| 2020 中国好声音总冠军｜《好久不见》｜11/20/2020 武汉巅峰夜总决赛第一轮歌曲": ["好久不见", "单依纯"],
  "单依纯《你就不要想起我》原唱:田馥甄": ["你就不要想起我", "单依纯"],
  "单依纯最新歌曲合集 《你的珍藏》中国好声音2020歌曲": ["你的珍藏", "单依纯"],
  "單依純 -《給電影人的情書》(電影 一秒鐘 推廣曲)｜CC歌詞字幕": ["给电影人的情书", "单依纯"],
  "【黑胶纯享】技巧满分气息超稳！单依纯演唱《三人游》温柔而不失力量感《声生不息》 Infinity and Beyond EP5丨MangoTV": ["三人游", "单依纯"],
  "[ 你的专属女友音在为你吟唱 | 赵露思/单依纯/欧阳娜娜/陈卓璇/黄霄雲/赖美云/宋雨琦/房东的猫/谢春花|芒种/永不失联的爱/下雨天/爱笑的眼睛] 主题音乐盘点 / 浙江卫视官方HD /": ["女友音", "赵露思/单依纯/欧阳娜娜/陈卓璇/黄霄雲/赖美云/宋雨琦/房东的猫/谢春花|芒种/永不失联的爱/下雨天/爱笑的眼睛"],
  "左手指月 (電視劇《香蜜沉沉燼如霜》片尾曲)": ["左手指月", "萨顶顶"],
  "新年共演《New Boy》│Nana OuYang 歐陽娜娜": ["New Boy", "欧阳娜娜"],
  "李榮浩 01 老街": ["老街", "李荣浩"],
  "李榮浩 02 小黃 (北京市保護小動物協會宣傳歌曲)": ["小黄", "李荣浩"],
  "杰倫心目中的完美cover-蔡健雅(愛情廢柴X說好不哭)": ["說好不哭", "蔡健雅"],
  "Mirai - Open Up Your Mind (with lyrics & translation)": ["Open Up Your Mind", "Mirai"],
  "Ai De Jiu Shi Ni": ["爱的就是你", "王力宏"],
  "Da Cheng Xiao Ai": ["大城小爱", "王力宏"],
  "Hua Tian Cuo": ["花田错", "王力宏"],
  "Ni Bu Zhi Dao De Shi": ["你不知道的事", "王力宏"],
  "Wei Yi": ["唯一", "王力宏"],
  "[Engsub]  Faye Wong - Hong Dou": ["红豆", "王菲"],
  "王菲 Eyes on Me 高清音质纯享版": ["Eyes on Me", "王菲"],
  "Brave Heart - Digimon": ["Brave Heart", "Digimon"],
  "Sum 41 - This Is Goodbye - HQ": ["This is Goodbye", "Sum 41"]
}
let aa = {
  "Danny Chan": "陈百强",
  "David Tao": "陶喆",
  "Fan Xiao Xuan": "范晓萱",
  "Gigi Leung": "梁咏琪",
  "Harlem Yu": "庾澄庆",
  "Karen Mok": "莫文蔚",
  "Lala Hsu": "徐佳莹",
  "Leehom Wang": "王力宏",
  "Li Jian": "李健",
  "Li Ronghao": "李荣浩",
  "Mao Bu-Yi": "毛不易",
  "Penny Tai": "戴佩妮",
  "Sandy Lam": "林忆莲",
  "林憶蓮": "林忆莲",
  "Shunza": "顺子",
  "Sun Yanzi": "孙燕姿",
  "單依純": "单依纯",
  "Wanting": "曲婉婷",
  "Xu Wei": "许巍",
  "Yu Quan": "羽泉",
  "逃跑計劃": "逃跑计划",
  "陳一發兒": "陈一发儿",
  "aiko": "Aiko",
  "Huang Xiaoyun": "黄霄云",
  "IU(아이유)": "IU",
  "Joanna Wang": "王若琳",
  "陳綺貞 (Cheer Chen)": "陈绮贞",
  "Faye Wong": "王菲",
  "郭靜": "郭静",
  "周杰倫": "周杰伦",
  "朴樹": "朴树",
  "Jolin Tsai": "蔡依林",
  "范瑋琪": "范玮琪",
  "歐陽娜娜": "欧阳娜娜",
  "JJ Lin": "林俊杰",
  "林俊傑": "林俊杰"
}

let sortFunc = (sortField, sortOrder, titleRules, artistRules) => {
  let container = document.querySelector("div#contents.style-scope.ytmusic-playlist-shelf-renderer")
  if (container.childNodes.length == 99) {
    alert("There are 99 songs currently listed. Please scroll down and re-run if there are more than 99 songs.")
  }
  var songNames = {}
  var duplicatedSongs = []
  // collect songs into array
  var songs = []
  container.childNodes.forEach(card => {
    let titleElement = card.querySelector("div.title-column yt-formatted-string[title]")
    let title = titleElement.getAttribute("title")
    let metaInfo = card.querySelectorAll("div.secondary-flex-columns yt-formatted-string[title]")
    let artistElement = metaInfo[0]
    let artist = artistElement.getAttribute("title")
    let album = metaInfo.length > 1 ? metaInfo[1].getAttribute("title") : " "
    console.log(`[${title}] [${artist}] [${album}]`)
    if (title in titleRules) {
      let newInfo = titleRules[title]
      console.log(`=== modifying song [${title}] with title [${newInfo[0]}] and artist [${newInfo[1]}]`)
      title = newInfo[0]
      artist = newInfo[1]
      titleElement.querySelector("a").textContent = title
      artistElement.querySelector("a").textContent = artist
    }
    if (artist in artistRules) {
      let newName = artistRules[artist]
      console.log(`=== modifying artist name [${artist}] with [${newName}]`)
      artist = newName
      artistElement.querySelector("a").textContent = artist
    }
    let uniqueName = title + "-" + artist
    if (uniqueName in songNames) {
      duplicatedSongs.push(uniqueName)
    } else {
      songNames[uniqueName] = 1
    }
    songs.push({
      t: title.replace(/[[ (]/, "").trim(),
      a: artist.replace(/[[ (]/, "").trim(),
      ab: album,
      c: card
    })
  });
  // Sort by song: title > artist > album
  // Sort by artist: artist > album > title
  songs.sort((s1, s2) => {
    var res = 0
    if (sortField == "Song") {
      res = s1.t.localeCompare(s2.t)
      if (res == 0) { res = s1.a.localeCompare(s2.a) }
      if (res == 0) { res = s1.ab.localeCompare(s2.ab) }
    } else {
      res = s1.a.localeCompare(s2.a)
      if (res == 0) { res = s1.ab.localeCompare(s2.ab) }
      if (res == 0) { res = s1.t.localeCompare(s2.t) }
    }
    return sortOrder == "Ascending" ? res : -res;
  })
  // re-order the DOM
  container.innerHTML = ""
  songs.forEach(song => {
    container.appendChild(song.c)
  });
  // report duplicated songs
  if (duplicatedSongs.length > 0) {
    alert("Duplicated songs:" + duplicatedSongs.join(", "))
  }
}

const sortButton = document.getElementById("sortButton");
if (sortButton) {
  sortButton.onclick = function () {
    const sortField = document.querySelector("input[name='sortField']:checked").value
    const sortOrder = document.querySelector("input[name='sortOrder']:checked").value
    chrome.tabs.query({ active: true, currentWindow: true }).then(([tab]) => {
      if (!tab.url.startsWith("https://music.youtube.com/playlist?")) {
        console.log("Not a youtube music playlist page")
        return
      }
      loadTitleRules((titleRules) => {
        loadArtistRules((artistRules) => {
          chrome.scripting.executeScript({
            target: { tabId: tab.id },
            args: [sortField, sortOrder, titleRules, artistRules],
            func: sortFunc
          }, () => {
            window.close();
          });
        })
      })

    })
  };
}